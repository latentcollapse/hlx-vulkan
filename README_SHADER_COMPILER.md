# HLX Shader Compiler - CONTRACT_1001

CLI tool to compile GLSL shaders to SPIR-V with HLX CONTRACT_900 generation.

## Overview

`hlx-shader-compiler` is a Tier 1 HLX ecosystem tool that:

1. **Compiles GLSL to SPIR-V** using glslc (preferred) or glslangValidator (fallback)
2. **Validates SPIR-V** magic number (0x07230203) and structure
3. **Generates content-addressed handles** for deterministic shader identification
4. **Outputs CONTRACT_900** in JSON or HLXL format

## Installation

```bash
# Build from hlx-vulkan directory
cargo build --release --bin hlx_shader_compiler

# Binary location
./target/release/hlx_shader_compiler
```

### Prerequisites

Install a GLSL compiler (one of):

```bash
# Arch Linux (recommended - includes glslc)
sudo pacman -S shaderc

# Ubuntu/Debian
sudo apt install glslc

# macOS
brew install shaderc

# Fallback: Khronos glslangValidator
sudo pacman -S vulkan-tools  # Arch
sudo apt install glslang-tools  # Ubuntu
```

## Usage

### Compile a Shader

```bash
# Basic compilation (auto-detects stage from extension)
hlx-shader-compiler compile shaders/cube.vert
# Output: CONTRACT_900 JSON + Handle

# Specify output file
hlx-shader-compiler compile shaders/cube.frag -o compiled/cube.frag.spv

# Explicit stage (when extension is ambiguous)
hlx-shader-compiler compile shaders/postprocess.glsl --stage fragment

# Output HLXL format instead of JSON
hlx-shader-compiler compile shaders/cube.vert --hlxl

# Skip ShaderDatabase storage (compile only)
hlx-shader-compiler compile shaders/cube.vert --no-store

# Force recompilation even if output exists
hlx-shader-compiler compile shaders/cube.vert --force
```

### Check Available Compiler

```bash
hlx-shader-compiler check-compiler
# Output: Found: glslc (Google shaderc) - PREFERRED
```

### Validate SPIR-V File

```bash
hlx-shader-compiler validate compiled/cube.vert.spv
# Output: Valid SPIR-V: compiled/cube.vert.spv
#         Size: 1456 bytes
#         Version: 1.0
#         Magic: 0x07230203
#         Handle: &h_shader_a1b2c3d4...
```

## Output Formats

### JSON (default)

```json
{
  "900": {
    "@0": "cube",
    "@1": "base64:AwIjBwAAAQAAAA...",
    "@2": "main",
    "@3": "vertex"
  }
}
```

### HLXL (--hlxl flag)

```hlxl
// CONTRACT_900: VulkanShader
// Generated by hlx-shader-compiler

let cube = contract 900 {
  shader_name: "cube",
  spirv_binary: &h_shader_a1b2c3d4...,
  entry_point: "main",
  stage: "vertex"
};
```

## CONTRACT_900 Fields

| Field | Index | Description |
|-------|-------|-------------|
| shader_name | @0 | Human-readable shader name |
| spirv_binary | @1 | SPIR-V bytes (base64 in JSON, handle in HLXL) |
| entry_point | @2 | Shader entry point (usually "main") |
| stage | @3 | Shader stage: vertex, fragment, compute, geometry |

## Supported Shader Stages

| Extension | Stage | Flag |
|-----------|-------|------|
| .vert | vertex | --stage vertex |
| .frag | fragment | --stage fragment |
| .comp | compute | --stage compute |
| .geom | geometry | --stage geometry |
| .tesc | tesscontrol | --stage tesscontrol |
| .tese | tesseval | --stage tesseval |

## HLX Axioms Verified

### A1: DETERMINISM

Same GLSL source file always produces the same SPIR-V binary, which produces the same handle.

```bash
# Run twice - same handle both times
hlx-shader-compiler compile cube.vert
# Handle: &h_shader_a1b2c3d4...

hlx-shader-compiler compile cube.vert
# Handle: &h_shader_a1b2c3d4...  (identical)
```

### A2: REVERSIBILITY

The handle points to the original SPIR-V binary, which can be retrieved losslessly from ShaderDatabase.

```bash
# Store shader
hlx-shader-compiler compile cube.vert --shader-db-path ./shaders_db

# Later: retrieve by handle (using Python runtime)
python -c "
from hlx_runtime.shaderdb import ShaderDatabase
db = ShaderDatabase('./shaders_db')
spirv = db.get('&h_shader_a1b2c3d4...')
# spirv == original bytes
"
```

## Invariants

### INV-001: TOTAL_FIDELITY

GLSL -> SPIR-V -> resolve = working shader

The shader database preserves the exact SPIR-V binary. No lossy transformations.

## Error Handling

The compiler provides clear error messages with line/column information:

```
Shader compilation failed: shaders/broken.vert
----------------------------------------
  ERROR: shaders/broken.vert:15: 'gl_Position' : undeclared identifier
  ERROR: shaders/broken.vert:15: 'assign' : cannot convert from 'void' to 'highp 4-component vector of float'
----------------------------------------
```

## Example Workflow

See `examples/compile_cube_shaders.sh` for a complete workflow:

```bash
#!/bin/bash
# Compile all cube demo shaders

hlx-shader-compiler compile shaders/cube.vert -o compiled/cube.vert.spv
hlx-shader-compiler compile shaders/cube.frag -o compiled/cube.frag.spv

# Generate HLXL contracts
hlx-shader-compiler compile shaders/cube.vert --hlxl > contracts/cube_vert.hlxl
hlx-shader-compiler compile shaders/cube.frag --hlxl > contracts/cube_frag.hlxl
```

## Integration with HLX Runtime

The shader compiler integrates with the HLX runtime through ShaderDatabase:

```python
from hlx_runtime.shaderdb import ShaderDatabase

# Open database
db = ShaderDatabase("/var/lib/hlx/shaders")

# Query shaders by properties
results = db.query(shader_stage="vertex")

# Get SPIR-V by handle
spirv = db.get("&h_shader_a1b2c3d4...")

# Stats
print(db.stats())
```

## Architecture

```
GLSL Source (.vert/.frag/.comp)
        |
        v
[hlx-shader-compiler]
        |
        +---> Detect compiler (glslc or glslangValidator)
        |
        +---> Compile GLSL to SPIR-V
        |
        +---> Validate SPIR-V magic (0x07230203)
        |
        +---> Compute content-addressed handle
        |
        +---> Generate CONTRACT_900 (JSON or HLXL)
        |
        v
SPIR-V Binary (.spv) + Handle + CONTRACT_900
```

## Test Checklist

### Model-Verified (Automatic)

- [x] SPIR-V magic validation (0x07230203)
- [x] CONTRACT_900 field order (@0, @1, @2, @3)
- [x] Determinism: same shader -> same handle (run 2x)

### Human-Verified (Manual Testing)

- [ ] Compiles .vert files
- [ ] Compiles .frag files
- [ ] Auto-detects compiler (glslc preferred)
- [ ] Falls back to glslangValidator if needed
- [ ] Produces correct SPIR-V magic
- [ ] Generates valid CONTRACT_900
- [ ] Handles invalid GLSL gracefully
- [ ] Error messages are helpful

## References

- [CONTRACT_1001 Specification](../TIER1_TOOLS_CONTRACTS.hlxl)
- [HLX Canonical Corpus](../HLX_CORPUS/HLX_CANONICAL_CORPUS_v1.0.0.md)
- [Phase 2 Validation](src/validation.rs)
- [ShaderDatabase](hlx_runtime/shaderdb.py)
